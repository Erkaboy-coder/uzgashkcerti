{% extends "labcerti/base.html" %}
{% load static %}

{% block title %}Guvohnoma {{ cert.certificate_number }}{% endblock %}
{% block page_title %}Guvohnoma tafsilotlari{% endblock %}
{% block breadcrumb %}Guvohnoma tafsilotlari{% endblock %}

{% block content %}
<style>
    /*
    * Responsive va ixchamlashtirilgan CSS
    */

    .certificate-container {
        /* Ekran o'lchamiga moslashuvchan, maksimal kengligi 210mm */
        max-width: 210mm;
        margin: 0 auto;
        padding: 20px;
        box-sizing: border-box;
        border: 10px groove #bbe7c7;
        overflow: hidden;
        font-family: 'Arial', sans-serif;
        /* Fon rasmi takrorlanuvchi */
        background-image: url('{% static 'assets/img/bg5.png' %}');
        background-repeat: repeat;
        position: relative;
    }

    /* Barcha shriftlar uchun umumiy sozlamalar */
    .certificate-container h1, .certificate-container h2, .certificate-container h5 {
        font-size: clamp(0.9rem, 2.8vw, 1.4rem); /* Shriftlar biroz kichraytirildi */
        line-height: 1.2;
    }

    .certificate-container p, .certificate-container span, .certificate-container i, .certificate-container small {
        font-size: clamp(0.65rem, 1.8vw, 0.9rem); /* Shriftlar biroz kichraytirildi */
        line-height: 1.4;
    }

    /* MATN JOYLASHTIRISH UCHUN YANGI CSS QOIDALAR */
    .certificate-text-block {
        text-align: center;
        margin-bottom: 8px;
    }

    .main-line-container {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap; /* Matnning keyingi qatorga o'tishini ta'minlaydi */
        justify-content: center;
        align-items: flex-end;
        text-align: center;
        width: 100%;
        margin-bottom: 5px; /* Pastki matndan ajratish uchun bo'shliq */
    }

    .main-line-container span {
        font-size: clamp(0.65rem, 1.8vw, 0.9rem);
        display: inline-block; /* Elementlarga kenglik berish uchun */
        white-space: normal; /* Matnning o'z-o'zidan qatorga o'tishiga ruxsat beradi */
        word-break: break-word; /* Uzoq so'zlarni qismlarga bo'ladi */
    }

    /* Faqat chiziq ostida bo'lishi kerak bo'lgan matnlar uchun */
    .main-line-container .main-text {
        border-bottom: 1px solid black;
        padding-bottom: 2px;
        flex-grow: 1;
        text-align: center;
        margin: 0 5px;
        font-weight: bold;
    }

    /* "foydalangan holda" kabi so'zlar uchun maxsus qoida */
    .main-line-container .end-text {
        flex-shrink: 0; /* Bo'shliq kamayganda qisqarmaydi */
        margin-left: auto; /* O'ng tomonga surib yuboradi */
    }

    .info-line {
        display: block;
        font-style: italic;
        font-size: clamp(0.55rem, 1.3vw, 0.75rem);
        margin-top: 3px;
        text-align: center;
    }
    /* YANGI CSS QOIDALARI TUGADI */

    .validity-period {
        text-align: right;
        font-size: clamp(0.7rem, 1.8vw, 0.9rem);
    }

    .certificate-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: 20px;
    }

    .certificate-footer-info {
        text-align: center;
        font-size: clamp(0.65rem, 1.8vw, 0.85rem);
    }

    .qr-code-area {
        height: 80px;
        width: 80px;
    }

    /* Kichik ekranlar uchun sozlamalar */
    @media (max-width: 768px) {
        .certificate-container {
            padding: 10px;
        }

        .certificate-footer {
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .validity-period {
            text-align: center;
            margin-top: 10px;
        }
    }
</style>

<div class="row">
    <div class="col-lg-{% if rejections %}9{% else %}12{% endif %} col-md-{% if rejections %}8{% else %}12{% endif %}">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-certificate me-2"></i>Guvohnoma {{ cert.certificate_number }}</h5>
                <a href="{% url 'creator:dashboard' %}" class="btn btn-light btn-sm shadow-sm rounded-3">
                    <i class="fas fa-arrow-left me-1"></i> Orqaga
                </a>
            </div>

            <div class="card-body p-4">
<div class="certificate-container">
                    <div class="text-center text-primary mb-2">
                        <h6 class="fw-bold mb-0">O‘ZBEKISTON RESPUBLIKASIDA O‘LCHASHLARNING YAGONA BIRLIKDA<br> BO'LISHINI TA’MINLASH TIZIMI</h6>
                    </div>
                    <div class="text-center mb-3">
                        <h7 class="border-bottom border-dark pb-1">{{ cert.service_provider_name }}</h7>
                        <i class="d-block" style="font-size: clamp(0.55rem, 1.3vw, 0.75rem);">(o'lchash vositasini qiyoslashni o'tkazgan metrologiya xizmatining nomi)</i>
                    </div>

                    <div class="text-center mb-3">
                        <p class="fw-bold fs-5 mb-0">{{ cert.certificate_number }} - son</p>
                        <h2 class="fw-bold mb-1">O‘lchash vositasini qiyoslash</h2>
                        <h1 class="fw-bolder text-primary mb-1">GUVOHNOMASI</h1>
                    </div>

                    <div class="validity-period">
                        <p class="mb-0">Amal qilish muddati:</p>
                        <strong class="d-block">{{ cert.valid_until_date|date:"Y" }}-yil {{ cert.valid_until_date|date:"d" }}-{{ cert.valid_until_date|date:"F" }}gacha</strong>
                    </div>

                    <div class="certificate-main-content mt-4">
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">Ushbu guvohnoma {{ cert.standards_used }} </span>
                                <span class="end-text">foydalangan holda</span>
                            </div>
                            <i class="info-line">(etalonlar (namunaviy o'lchash vositalari)ning belgilanishi va nomi, qiyoslangan sanasi)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.comparison_document }}</span>
                                <span class="end-text">ga muvofiq</span>
                            </div>
                            <i class="info-line">(qiyoslash bo'yicha xujjatning belgilanishi va nomlanishi)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.service_provider_name }}</span>
                                <span class="end-text">tomonidan qiyoslangan</span>
                            </div>
                            <i class="info-line">(o'lchash vositalarini qiyoslagan metrologiya xizmatining nomi)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.owner_name }}</span>
                                <span class="end-text">ga tegishli</span>
                            </div>
                            <i class="info-line">(o'lchash vositalarining egasi - yuridik shaxs)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.manufacturer }}</span>
                                <span class="end-text"></span>
                            </div>
                            <i class="info-line">(o'lchash vositalarini tayyorlovchi)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.origin_country }}</span>
                                <span class="end-text">tomonidan tayyorlangan (import qilingan)</span>
                            </div>
                            <i class="info-line">(o'lchash vositalarining tayyorlovchi - import qiluvchi mamlakat)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.measurement_range }}</span>
                                <span class="end-text"></span>
                            </div>
                            <i class="info-line">(o'lchash vositalari parametrlarining nomi, o'lchashlar,</i>
                        </div>

                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.error_limit }}</span>
                                <span class="end-text">metrologik tavsifli</span>
                            </div>
                            <i class="info-line">xatolik chegaralari, aniqlik klassi)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.device_name }} {{ cert.device_serial_numbers }}</span>
                                <span class="end-text">o'lchash vositasi</span>
                            </div>
                            <i class="info-line">(o'lchash vositalarining nomlanishi va belgilanishi, zavod raqami)</i>
                        </div>
                        
                        <div class="certificate-text-block">
                            <div class="main-line-container">
                                <span class="main-text">{{ cert.comparison_methodology_doc }}</span>
                                <span class="end-text"></span>
                            </div>
                            <i class="info-line">(o'lchash vositalariga qo'yiladigan talablarni reglamentlovchi normativ xujjat belgilanishi va nomi)</i>
                        </div>
                        
                        <div class="text-left fw-bold">
                            <span>talablariga moslig va davlat metrologik tekshiruvi va nazorati tatbiq etilish sohasida qo'llanishiga yo'l qo'yilishini tasdiqlaydi.</span>
                        </div>

                        {% if cert.protocol_file %}
                            <div class="text-end mt-3">
                                <span class="fw-bold">Protokol fayli:</span>
                                <a href="{{ cert.protocol_file.url }}" target="_blank" class="ms-2">PDF faylni ko‘rish</a>
                            </div>
                        {% endif %}
                    </div>

                    <div class="certificate-footer">
                        <div class="qr-code-area">
                            {% if cert.qr_code_image %}
                                <img src="{{ cert.qr_code_image.url }}" alt="QR code" class="img-fluid">
                            {% else %}
                                <div class="border border-secondary rounded d-flex align-items-center justify-content-center h-100 text-muted">QR CODE JOY</div>
                            {% endif %}
                        </div>

                        <div class="certificate-footer-info">
                            <p class="mb-2">Qiyoslash sanasi: <strong>{{ cert.comparison_date|date:"Y" }}-yil {{ cert.comparison_date|date:"d" }}-{{ cert.comparison_date|date:"F" }}</strong></p>
                            <p class="mb-0">Qiyoslovchi <strong>{{ cert.metrologist }}</strong></p>
                            <i class="d-block">(F.I.SH.)</i>
                        </div>
                    </div>

                    <div class="text-center text-danger mt-3">
                        <i class="fw-bold">
                            Mazkur guvohnomani qalbakilashtirish - qonunga muvofiq javobgarlikka tortiladi.
                        </i>
                    </div>
                </div>

                <div class="mt-4 text-center">
                    {% if cert.status == 'pending' %}
                        <form method="post" action="{% url 'approver:approve_certificate' cert.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success me-2">
                                <i class="fas fa-check me-1"></i> Tasdiqlash
                            </button>
                        </form>
                        <a href="{% url 'approver:reject_certificate' cert.id %}"
                           class="btn btn-danger rejectBtn"
                           data-cert-number="{{ cert.certificate_number }}"
                           data-device-name="{{ cert.device_name }}"
                           data-device-serial="{{ cert.device_serial_numbers }}"
                           data-url="{% url 'approver:reject_certificate' cert.id %}"
                           title="Rad etish">
                           <i class="fas fa-times"></i> Rad etish
                        </a>
                        {% include "labcerti/components/reject_modal.html" %}
                    {% endif %}
                    {% if cert.certificate_file %}
                        <a href="{{ cert.certificate_file.url }}" target="_blank" class="btn btn-primary ms-2">
                            <i class="fas fa-file-pdf me-1"></i> PDF ko'rish
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if rejections %}
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card shadow-lg border-danger rounded-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>Qaytarilish sabablari</h6>
                </div>
                <div class="card-body p-3">
                    <div class="list-group list-group-flush">
                        {% for rej in rejections %}
                            <div class="list-group-item p-2">
                                <div class="d-flex w-100 justify-content-between mb-1">
                                    <small class="text-danger fw-bold">
                                        <i class="fas fa-user-circle me-1"></i>
                                        {{ rej.rejected_by.user.get_full_name|default:rej.rejected_by.user.username }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="far fa-clock me-1"></i>{{ rej.created_at|date:"d.m.Y H:i" }}
                                    </small>
                                </div>
                                <p class="mb-0 small fst-italic">"{{ rej.reason }}"</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}